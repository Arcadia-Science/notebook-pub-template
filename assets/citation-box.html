<template id="citation-box-template">
  <div id="citation-popup" class="citation-popup">
    <div class="citation-popup-content">
      <div class="citation-header">
        <h4>Cite this pub</h4>
        <button id="close-citation-box" class="close-button" aria-label="Close citation box">Ã—</button>
      </div>
      <div class="citation-tabs">
        <button class="citation-tab-button active" data-format="styled">Arcadia</button>
        <button class="citation-tab-button" data-format="bibtex">BibTeX</button>
      </div>
      <div class="citation-body">
        <div id="styled-citation" class="citation-content active">
          <p class="loading-text">Loading citation...</p>
        </div>
        <div id="bibtex-citation" class="citation-content">
          <pre class="loading-text">Loading citation...</pre>
        </div>
      </div>
      <div class="citation-footer">
        <button id="copy-citation-button" class="copy-button">
          <i class="bi bi-clipboard"></i> Copy to clipboard
        </button>
      </div>
    </div>
  </div>
</template>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add citation box to the document
    const template = document.getElementById('citation-box-template');
    if (template) {
      const citationBoxContent = document.importNode(template.content, true);
      document.body.appendChild(citationBoxContent);
    }

    // Find citation button that was created by Quarto in the navbar
    const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
    let citeButton = null;
    for (const link of navLinks) {
      if (link.textContent.trim().includes('Cite this pub')) {
        citeButton = link;
        break;
      }
    }

    // If we couldn't find the button, don't initialize
    if (!citeButton) {
      console.warn('Citation button not found in navbar');
      return;
    }

    // Reference elements
    const citationPopup = document.getElementById('citation-popup');
    const closeButton = document.getElementById('close-citation-box');
    const copyButton = document.getElementById('copy-citation-button');
    const tabButtons = document.querySelectorAll('.citation-tab-button');
    const styledEl = document.getElementById('styled-citation');
    const bibtexEl = document.getElementById('bibtex-citation');
    const citationBody = document.querySelector('.citation-body');

    // Citation data
    let pubData = {};
    let citationLoadError = false; // Flag to track if loading failed

    // --- Function to display error message ---
    function displayCitationError() {
      citationLoadError = true; // Set the error flag
      const errorMessage = `<p>Error generating citation. Please visit <a href="https://research.arcadiascience.com" target="_blank">research.arcadiascience.com</a> to get the citation for this pub.</p>`;

      // Display error message in all content areas
      if (styledEl) styledEl.innerHTML = errorMessage;
      // apaEl reference removed
      if (bibtexEl) bibtexEl.innerHTML = `<pre>${errorMessage}</pre>`; // Use <pre> for BibTeX area consistency

      // Hide copy button and tabs
      if (copyButton) copyButton.style.display = 'none';
      const citationTabs = document.querySelector('.citation-tabs');
      if (citationTabs) citationTabs.style.display = 'none';

      // Ensure the first content area (Arcadia) is visible if tabs are hidden
      if (styledEl) styledEl.classList.add('active');
      if (bibtexEl) bibtexEl.classList.remove('active');
    }

    // Function to load the citation data
    async function loadCitationData() {
      // Reset error state and visibility on load attempt
      citationLoadError = false;
      if (copyButton) copyButton.style.display = ''; // Show copy button initially
      const citationTabs = document.querySelector('.citation-tabs');
      if (citationTabs) citationTabs.style.display = ''; // Show tabs initially

      // Reset loading text
      const loadingMessage = `<p class="loading-text">Loading citation...</p>`;
      const loadingPreMessage = `<pre class="loading-text">Loading citation...</pre>`;
      if (styledEl) styledEl.innerHTML = loadingMessage;
      if (bibtexEl) bibtexEl.innerHTML = loadingPreMessage;


      try {
        const response = await fetch('/CITATION.cff');

        if (!response.ok) {
          console.warn('CITATION.cff file not found or fetch failed.');
          displayCitationError();
          return;
        }

        const text = await response.text();

        pubData = {
          title: extractSimpleValue(text, 'title:'),
          year: extractSimpleValue(text, 'year:'),
          doi: extractSimpleValue(text, 'doi:'),
          authors: []
        };

        // Check required data is present before proceeding
        if (!pubData.title) {
           console.warn('Could not parse title from CITATION.cff.');
           displayCitationError(); // Treat missing title as error
           return;
        }
        if (!pubData.year) {
           console.warn('Could not parse year from CITATION.cff.');
           displayCitationError(); // Treat missing year as error
           return;
        }
        if (!pubData.doi) {
           console.warn('Could not parse DOI from CITATION.cff.');
           displayCitationError(); // Treat missing DOI as error
           return;
        }

        let authorsSection = '';
        if (text.includes('preferred-citation:')) {
          // Regex targets authors within preferred-citation block
          const prefCitationMatch = text.match(/preferred-citation:[\s\S]*?authors:([\s\S]*?)(?:year:|$)/);
          if (prefCitationMatch && prefCitationMatch[1]) {
            authorsSection = prefCitationMatch[1];
          } else {
              console.warn('Found preferred-citation but could not extract authors section within it.');
              displayCitationError(); // Error if preferred-citation exists but authors subsection doesn't parse
              return;
          }
        } else {
           // Error if preferred-citation is missing
           console.warn('Required section "preferred-citation:" not found in CITATION.cff.');
           displayCitationError();
           return;
        }

        // Author parsing
        const authorMatches = authorsSection.matchAll(/- family-names:\s*([^\n]+)(?:[\s\S]*?)given-names:\s*([^\n]+)/g);

        for (const match of authorMatches) {
          if (match[1] && match[2]) {
            pubData.authors.push({
              family: match[1].trim(),
              given: match[2].trim()
            });
          }
        }

        // Error if no authors were found specifically in preferred-citation
        if (pubData.authors.length === 0) {
          console.warn('No authors found or parsed within preferred-citation section of CITATION.cff.');
          displayCitationError();
          return;
        }

        updateCitations(); // Update only if everything succeeded

      } catch (error) {
        console.error('Error loading or processing citation data:', error);
        displayCitationError();
      }
    }

    function extractSimpleValue(text, key) {
        // Improved regex to handle potential comments and ensure start of line or indentation for keys
        const regex = new RegExp(`^(?: *|\\t*)${key}\\s*"?([^"\\n#]+)"?`, 'im');
        const match = text.match(regex);
        // Trim potential surrounding quotes and whitespace
        return match ? match[1].trim().replace(/^['"]|['"]$/g, '').trim() : '';
    }


    // Update citations with the data
    function updateCitations() {
      // Ensure we don't run this if there was an error
      if (citationLoadError) return;

      // Get the URL
      const url = pubData.doi ? `https://doi.org/${pubData.doi}` : window.location.href;

      // Arcadia citation (with initials)
      const styledAuthors = pubData.authors.map(author => {
        const initials = author.given.split(/\s+/).map(name => name.charAt(0)).join('');
        return `${author.family} ${initials}`;
      }).join(', ');

      // Arcadia citation
      styledEl.innerHTML = `<p>${styledAuthors}. (${pubData.year}). ${pubData.title}. ${url}</p>`;

      // BibTeX citation
      // Safety check for authors
      const firstAuthor = pubData.authors[0] || { family: 'Unknown', given: '' };
      const bibtexKey = `${firstAuthor.family.replace(/\W/g, '')}${pubData.year}${pubData.title.split(' ')[0].replace(/\W/g, '')}`;

      const escapedTitle = pubData.title.replace(/([{}])/g, '\\$1').replace(/\b([A-Z][a-zA-Z0-9]*)\b/g, '{$1}');


      const bibtexAuthors = pubData.authors.map(author =>
        `${author.family}, ${author.given}`
      ).join(' and ');

      const bibtexContent = `@article{${bibtexKey},
    author = {${bibtexAuthors}},
    title = {${escapedTitle}},
    journal = {Arcadia Science},
    year = {${pubData.year}},
    doi = {${pubData.doi}},
    url = {${url}}
  }`;
       const bibtexContentFinal = `@article{${bibtexKey},
    author = {${bibtexAuthors}},
    title = {${escapedTitle}},
    journal = {Arcadia Science},
    year = {${pubData.year}},${pubData.doi ? `\n    doi = {${pubData.doi}},` : ''}
    url = {${url}}
  }`;


      bibtexEl.innerHTML = `<pre>${bibtexContentFinal}</pre>`;
    }

    // Function to toggle the citation box
    function toggleCitationBox() {
      const isVisible = citationPopup.classList.contains('visible');

      if (!isVisible) {
        citationPopup.classList.add('visible');
        // Load citation data if not already loaded or if previous load failed
        if (!pubData.title || citationLoadError) {
          loadCitationData(); // This will reset state and try again
        }
      } else {
        citationPopup.classList.remove('visible');
      }
    }

    // Event listeners
    if (citeButton) {
      citeButton.addEventListener('click', function(e) {
        e.preventDefault();
        toggleCitationBox();
      });
    }

    if (closeButton) {
      closeButton.addEventListener('click', function() {
        citationPopup.classList.remove('visible');
      });
    }

    // Tab switching
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
         // Do nothing if tabs are hidden due to error
         if (citationLoadError) return;

        tabButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.citation-content').forEach(content => {
          content.classList.remove('active');
        });
        const format = this.getAttribute('data-format');
        document.getElementById(`${format}-citation`).classList.add('active');
      });
    });

    // Copy to clipboard functionality
    if (copyButton) {
      copyButton.addEventListener('click', function() {
         // Do nothing if the button is hidden
        if (copyButton.style.display === 'none') return;

        const activeTab = document.querySelector('.citation-tab-button.active');
        // Default to Arcadia if tabs might be hidden
        const activeFormat = activeTab ? activeTab.getAttribute('data-format') : 'styled';
        const contentEl = document.getElementById(`${activeFormat}-citation`);

        let textToCopy;
        // If error state, contentEl contains the error message - do not copy.
        if (citationLoadError || !contentEl) {
            console.warn("Attempted to copy citation during error state or element not found.");
            return;
        }

        if (activeFormat === 'bibtex') {
          const preElement = contentEl.querySelector('pre');
          textToCopy = preElement ? preElement.textContent : ''; // Safely get text
        } else {
          const pElement = contentEl.querySelector('p');
          textToCopy = pElement ? pElement.textContent.trim() : ''; // Safely get text
        }

        // Only proceed if there is text to copy
        if (!textToCopy) {
            console.warn("No text content found to copy for format:", activeFormat);
            return;
        }

        navigator.clipboard.writeText(textToCopy)
          .then(() => {
            copyButton.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
            setTimeout(() => {
               if (!citationLoadError) { // Only restore if not in error state
                 copyButton.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
               }
            }, 2000);
          })
          .catch(err => {
            console.error('Failed to copy: ', err);
            copyButton.innerHTML = '<i class="bi bi-x-lg"></i> Failed to copy';
            setTimeout(() => {
               if (!citationLoadError) { // Only restore if not in error state
                  copyButton.innerHTML = '<i class="bi bi-clipboard"></i> Copy to clipboard';
               }
            }, 2000);
          });
      });
    }

    // Close on escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' && citationPopup && citationPopup.classList.contains('visible')) {
        citationPopup.classList.remove('visible');
      }
    });
  });
</script>
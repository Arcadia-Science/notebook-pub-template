<template id="sticky-mini-title-template">
  <div class="sticky-mini-title">
    <div class="sticky-mini-title-content">
      <div class="logo-wrapper">
        <img src="./assets/logo_white.png" alt="Logo">
      </div>
      <p>{{< var pub.title>}}</p>
      <div id="mini-version-control"></div>
    </div>
  </div>
</template>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const template = document.getElementById('sticky-mini-title-template');
    const titleBanner = document.querySelector('.quarto-title-banner .quarto-title .title');
    const abstract = document.querySelector('.abstract');
    const navbar = document.querySelector('#quarto-header');
    const persistentHeight = 50;

    console.log("Elements found:", {
      template: !!template,
      titleBanner: !!titleBanner,
      abstract: !!abstract,
      navbar: !!navbar
    });

    if (template && titleBanner && abstract && navbar) {
      // Add the mini title to the document body
      const miniTitleContent = document.importNode(template.content, true);
      document.body.appendChild(miniTitleContent);

      // Clone the version control dropdown if it exists
      const originalDropdown = document.querySelector('.navbar-nav .nav-item.dropdown:has(iconify-icon[icon="qlementine-icons:version-control-16"])');
      if (originalDropdown) {
        const clonedDropdown = originalDropdown.cloneNode(true);
        // Remove menu-text class but keep contents
        const menuTextSpan = clonedDropdown.querySelector('.menu-text');
        if (menuTextSpan) {
          menuTextSpan.classList.remove('menu-text');
        }
        // Add to mini version control container
        const versionContainer = document.querySelector('#mini-version-control');
        versionContainer.appendChild(clonedDropdown);
        // Initialize Bootstrap dropdown
        if (typeof bootstrap !== 'undefined') {
          const dropdownElement = clonedDropdown.querySelector('.dropdown-toggle');
          if (dropdownElement) {
            new bootstrap.Dropdown(dropdownElement);
          }
        }
      }

      const stickyMiniTitle = document.querySelector('.sticky-mini-title');
      console.log("Sticky mini title found:", !!stickyMiniTitle);

      // Function to check navbar visibility
      function updateNavbarState() {
        const isNavbarPinned = navbar.classList.contains('headroom--pinned');
        const isNavbarTop = !navbar.classList.contains('headroom--not-top');

        if (isNavbarPinned || isNavbarTop) {
          document.body.classList.add('navbar-visible');
        } else {
          document.body.classList.remove('navbar-visible');
        }
      }

      // Create observer for navbar
      const navbarObserver = new MutationObserver(() => {
        updateNavbarState();
      });

      // Observe navbar class changes
      navbarObserver.observe(navbar, {
        attributes: true,
        attributeFilter: ['class']
      });

      // Initial navbar state check
      updateNavbarState();

      function expandMiniTitle() {
        document.body.classList.add('mini-title-visible');
        stickyMiniTitle.classList.add('visible');
      }

      function collapseMiniTitle() {
        document.body.classList.remove('mini-title-visible');
        stickyMiniTitle.classList.remove('visible');
      }

      // Create appear observer (triggers when abstract hits top)
      const appearObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach(entry => {
            if (!entry.isIntersecting && entry.boundingClientRect.top <= persistentHeight) {
              expandMiniTitle();
            }
          });
        },
        {
          threshold: [0],
          rootMargin: "0px"
        }
      );

      // Create disappear observer (original title banner logic)
      const disappearObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach(entry => {
            const visibleHeight = entry.intersectionRect.height;
            if (visibleHeight > persistentHeight) {
              collapseMiniTitle();
            }
          });
        },
        {
          threshold: Array.from({length: 100}, (_, i) => i / 100),
          rootMargin: "0px"
        }
      );

      // Start observing both elements
      appearObserver.observe(titleBanner);
      disappearObserver.observe(titleBanner);

      // Cleanup function
      window.addEventListener('beforeunload', () => {
        navbarObserver.disconnect();
        appearObserver.disconnect();
        disappearObserver.disconnect();
      });
    }
  });
</script>
